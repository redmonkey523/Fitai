name: CI

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ develop, main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install root deps
        run: npm ci
      - name: Install backend deps
        run: cd backend && npm ci
      - name: Grep guard for localhost/IP in runtime code
        run: |
          # Check for hardcoded localhost without environment variable fallbacks
          # Allow process.env checks and development fallbacks
          if grep -R --exclude-dir="node_modules" --exclude="*.md" --exclude="*.yaml" --exclude="*.yml" --exclude="env.example" --exclude=".env" --exclude="*.bat" --exclude="minimal-server.js" --exclude="debug-server.js" --exclude="api-client.ts" -E "http://localhost|https?://[0-9]{1,3}(\.[0-9]{1,3}){3}" src/ backend/routes/ backend/models/ backend/middleware/ backend/services/ | grep -v "process.env" | grep -v "NODE_ENV" | grep -v "||" | grep -v "fallback"; then
            echo "Found hardcoded hosts without env variable fallbacks" && exit 1
          else
            echo "âœ… No hardcoded hosts found in production code"
          fi
      - name: Start backend
        env:
          NODE_ENV: development
          PORT: 5000
          ENABLE_AI_DEMO: 'true'
        run: |
          node backend/server.js &
          sleep 3
      - name: Smoke tests
        env:
          API_BASE_URL: http://localhost:5000
        run: node scripts/smoke-test.js || (echo "Smoke failed" && exit 1)


